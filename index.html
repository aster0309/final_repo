<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¾…è¾¦æ¸…å–® - èªè­‰ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-3xl mx-auto">

        <div id="auth-section" class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 id="auth-title" class="text-2xl font-bold text-gray-800 mb-4">ğŸ”‘ ç™»å…¥ç³»çµ±</h2>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="å¸³è™Ÿ"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password" placeholder="å¯†ç¢¼"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <div class="flex gap-2">
                    <button onclick="handleLogin()"
                        class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">ç™»å…¥</button>
                    <button onclick="handleRegister()"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition">è¨»å†Šæ–°å¸³è™Ÿ</button>
                </div>
            </div>
        </div>

        <div id="main-content" class="hidden bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">ğŸ“ æˆ‘çš„å¾…è¾¦äº‹é …</h1>
                <button onclick="logout()" class="text-sm text-red-500 hover:underline">ç™»å‡º</button>
            </div>

            <div id="summary" class="grid grid-cols-3 gap-4 mb-8 text-center">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="text-sm text-blue-600">ç¸½ä»»å‹™</p>
                    <p id="total-tasks" class="text-xl font-bold">0</p>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <p class="text-sm text-red-600">ç·Šæ€¥äº‹é …</p>
                    <p id="urgent-tasks" class="text-xl font-bold">0</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <p class="text-sm text-green-600">å®Œæˆç‡</p>
                    <p id="completion-rate" class="text-xl font-bold">0%</p>
                </div>
            </div>

            <form id="todo-form" onsubmit="addTodo(event)" class="flex flex-wrap gap-2 mb-8">

                <input type="text" id="task-title" placeholder="è¼¸å…¥æ–°çš„ä»»å‹™åç¨±..." required
                    class="flex-1 min-w-[200px] px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">

                <input type="text" id="task-category" placeholder="é¡åˆ¥ (å¦‚:å·¥ä½œ)"
                    class="w-32 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">

                <input type="datetime-local" id="task-due-date"
                    class="px-2 py-2 border rounded-lg text-gray-600 focus:ring-2 focus:ring-blue-500">

                <select id="task-priority" class="px-2 py-2 border rounded-lg">
                    <option value="1">ä½</option>
                    <option value="2">ä¸­</option>
                    <option value="3">é«˜</option>
                </select>

                <button type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap">
                    æ–°å¢ä»»å‹™
                </button>
            </form>
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm text-gray-500">
                    æƒ³è¦å‚™ä»½è³‡æ–™å—ï¼Ÿ
                </div>
                <button onclick="downloadCSV()" 
                    class="flex items-center gap-2 px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    åŒ¯å‡º CSV å ±è¡¨
                </button>
            </div>
            <div class="mb-4 relative">
                <input type="text" id="search-input" oninput="debounceSearch()" placeholder="ğŸ” æœå°‹ä»»å‹™åç¨±..."
                    class="w-full px-10 py-2 border rounded-full focus:ring-2 focus:ring-blue-500 outline-none">
                <div class="absolute left-4 top-2.5 text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
            <div id="todo-list" class="space-y-3">
                <p class="text-center text-gray-500">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://final-repo-5o62.onrender.com";

        function setMinDateTime() {
            const now = new Date();

            // æ ¼å¼åŒ–ç‚º YYYY-MM-DDTHH:mm
            // å› ç‚º datetime-local éœ€è¦ ISO æ ¼å¼çš„å‰ 16 å€‹å­—å…ƒ
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const currentDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

            // è¨­å®š min å±¬æ€§
            document.getElementById('task-due-date').min = currentDateTime;
        }// é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        setMinDateTime();

        let currentCategory = ''; // ç´€éŒ„ç›®å‰é¸ä¸­çš„åˆ†é¡

        // ä¿®æ”¹ç¯©é¸å‡½æ•¸
        async function filterByCategory(category) {
            currentCategory = category;
            fetchTodos(); // é‡æ–°æŠ“å–è³‡æ–™
        }
        let searchTimer;
        function debounceSearch() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                // ç›´æ¥åŸ·è¡Œ fetchTodosï¼Œå®ƒå…§éƒ¨æœƒè‡ªå·±å»æŠ“ search-input çš„ value
                fetchTodos();
            }, 300);
        }
        // æ ¸å¿ƒè¨­å®šï¼šè®“ fetch è‡ªå‹•å¸¶ä¸Š Cookie 
        const fetchOptions = (method = 'GET', body = null) => {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include' // é‡è¦ï¼šé€™æœƒç™¼é€ Cookie 
            };
            if (body) options.body = JSON.stringify(body);
            return options;
        };
        async function authorizedFetch(url, options = {}) {
            return fetch(url, {
                ...options,
                credentials: 'include', // é‡è¦ï¼šé€™æœƒè®“ç€è¦½å™¨ç™¼é€ Cookie 
                headers: {
                    ...options.headers,
                    'Content-Type': 'application/json',
                }
            });
        }
        async function downloadCSV() {
            try {
                // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ fetch ä½†ä¸è½‰ JSONï¼Œè€Œæ˜¯è½‰æˆ blob (äºŒé€²åˆ¶å¤§å‹ç‰©ä»¶)
                const res = await fetch(`${API_URL}/todos/download/csv`, {
                    method: 'GET',
                    credentials: 'include' // ç¢ºä¿å¸¶ä¸Š Cookie ä»¥é€²è¡Œèº«åˆ†é©—è­‰
                });

                if (!res.ok) {
                    if (res.status === 401) return alert("è«‹å…ˆç™»å…¥");
                    throw new Error("ä¸‹è¼‰å¤±æ•—");
                }

                // 1. å–å¾—æª”æ¡ˆå…§å®¹
                const blob = await res.blob();
                
                // 2. å»ºç«‹ä¸€å€‹è™›æ“¬çš„ URL æŒ‡å‘é€™å€‹å…§å®¹
                const url = window.URL.createObjectURL(blob);
                
                // 3. å»ºç«‹ä¸€å€‹éš±è—çš„ <a> æ¨™ç±¤ä¾†æ¨¡æ“¬é»æ“Šä¸‹è¼‰
                const a = document.createElement('a');
                a.href = url;
                
                // è¨­å®šæª”åï¼ˆé€™æœƒè¦†è“‹å¾Œç«¯å»ºè­°çš„åç¨±ï¼Œå¦‚æœä½ æƒ³ç”¨å¾Œç«¯çš„æª”åå¯ä»¥çœç•¥æ­¤è¡Œï¼‰
                const date = new Date().toISOString().slice(0, 10);
                a.download = `æˆ‘çš„å¾…è¾¦æ¸…å–®_${date}.csv`;
                
                // åŸ·è¡Œä¸‹è¼‰
                document.body.appendChild(a);
                a.click();
                
                // 4. æ¸…ç†ï¼šç§»é™¤æš«å­˜ç‰©ä»¶èˆ‡é€£çµ
                window.URL.revokeObjectURL(url);
                a.remove();
                
                console.log("CSV ä¸‹è¼‰æŒ‡ä»¤å·²ç™¼é€");
            } catch (err) {
                console.error("ä¸‹è¼‰å‡ºéŒ¯:", err);
                alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }
        // --- ç™»å…¥èˆ‡è¨»å†Šé‚è¼¯ ---

        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_URL}/login`, fetchOptions('POST', { username, password }));

                if (res.ok) {
                    alert("ç™»å…¥æˆåŠŸï¼");
                    await fetchTodos()
                } else {
                    const errorData = await res.json().catch(() => ({ detail: "å¾Œç«¯ç™¼ç”Ÿæœªé æœŸéŒ¯èª¤" }));
                    alert(errorData.detail || "ç™»å…¥å¤±æ•—");
                }
            } catch (err) {
                alert("ç„¡æ³•é€£ç·šè‡³å¾Œç«¯ä¼ºæœå™¨");
                alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
            }
        }

        async function handleRegister() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const res = await fetch(`${API_URL}/register`, fetchOptions('POST', { username, password }));
            if (res.ok) {
                alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼");
            } else {
                const data = await res.json();
                alert(data.detail || "è¨»å†Šå¤±æ•—");
            }
        }

        function showTodoApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }

        async function logout() {
            try {
                // 1. å‘Šè¨´å¾Œç«¯æˆ‘å€‘è¦åˆªé™¤ Cookie
                const res = await fetch(`${API_URL}/logout`, {
                    method: 'POST',
                    credentials: 'include' // é€™ä¸€è¡Œè¶…é‡è¦ï¼Œä¸ç„¶ Cookie åˆªä¸æ‰
                });

                if (res.ok) {
                    console.log("å¾Œç«¯ç™»å‡ºæˆåŠŸ");

                    // 2. æ¸…é™¤ä»‹é¢ç‹€æ…‹
                    document.getElementById('main-content').classList.add('hidden');
                    document.getElementById('auth-section').classList.remove('hidden');

                    // 3. (é¸åš) æ¸…ç©ºè¼¸å…¥æ¡†
                    document.getElementById('username').value = "";
                    document.getElementById('password').value = "";

                    // 4. å¼·åˆ¶é‡æ–°æ•´ç†ä¸€æ¬¡é é¢ï¼ˆæœ€ä¿éšªçš„åšæ³•ï¼Œç¢ºä¿æ‰€æœ‰ç‹€æ…‹æ­¸é›¶ï¼‰
                    window.location.reload();

                    setMinDateTime();
                }
            } catch (err) {
                console.error("ç™»å‡ºé€£ç·šå¤±æ•—:", err);
            }
        }

        // --- å¾…è¾¦æ¸…å–®é‚è¼¯ (éœ€åŠ å…¥èªè­‰è™•ç†) ---

        async function fetchTodos() {
            try {
                const params = new URLSearchParams();
                const searchInput = document.getElementById('search-input');

                // æ ¸å¿ƒé‚è¼¯ï¼šå°‡æœå°‹æ¡†å…§å®¹ç›´æ¥å¡«å…¥ category åƒæ•¸
                if (searchInput && searchInput.value.trim()) {
                    params.append('category', searchInput.value.trim());
                }

                const url = `${API_URL}/todos/?${params.toString()}`;
                const res = await fetch(url, fetchOptions());

                if (res.status === 401) {
                    console.warn("ä½¿ç”¨è€…æœªèªè­‰ï¼Œè«‹å…ˆç™»å…¥");
                    return;
                }

                if (res.ok) {
                    const result = await res.json();
                    const summaryRes = await fetch(`${API_URL}/todos/summary`, fetchOptions());
                    const summary = await summaryRes.json();

                    updateUI(result.data, summary);
                    showTodoApp();
                }
            } catch (err) {
                console.error("æœå°‹åˆ†é¡å¤±æ•—:", err);
            }
        }

        function updateUI(todos, summary) {
            document.getElementById('total-tasks').innerText = summary.total_tasks;
            document.getElementById('urgent-tasks').innerText = summary.urgent_tasks;
            document.getElementById('completion-rate').innerText = summary.completion_rate;

            const list = document.getElementById('todo-list');
            list.innerHTML = todos.length ? "" : '<p class="text-center text-gray-500">ç›®å‰æ²’æœ‰ä»»å‹™</p>';

            todos.forEach(todo => {
                const item = document.createElement('div');

                // 1. æ±ºå®šå¤–æ¡†æ¨£å¼ï¼šå¦‚æœéæœŸä¸”æœªå®Œæˆï¼Œçµ¦å®ƒç´…æ¡†
                const borderClass = (todo.is_expired && !todo.is_completed) ? 'border-red-500 bg-red-50' : (todo.is_completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-200');

                item.className = `flex items-center justify-between p-4 border rounded-lg shadow-sm transition-all ${borderClass}`;

                // 2. æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º (å¦‚æœæœ‰ due_date)
                const dateDisplay = todo.due_date ? new Date(todo.due_date).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'ç„¡æœŸé™';

                item.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="checkbox" ${todo.is_completed ? 'checked' : ''} 
                        onchange="toggleComplete(${todo.id})" class="w-5 h-5 cursor-pointer accent-blue-600">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="${todo.is_completed ? 'line-through text-gray-400' : (todo.is_expired ? 'text-red-600 font-bold' : 'text-gray-800')} font-medium">
                                ${todo.title}
                            </span>
                            
                            <span class="text-xs px-2 py-0.5 rounded ${todo.priority >= 3 ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-500'}">P${todo.priority}</span>
                            
                            ${(todo.is_expired && !todo.is_completed) ? '<span class="text-[10px] bg-red-600 text-white px-1.5 py-0.5 rounded-full animate-pulse">å·²é€¾æœŸ</span>' : ''}
                            <span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded italic">
                                #${todo.category || 'ä¸€èˆ¬'}
                        </div>
                       
                        <div class="text-xs ${todo.is_expired && !todo.is_completed ? 'text-red-400' : 'text-gray-400'} mt-1">
                            æˆªæ­¢æ—¥ï¼š${dateDisplay}
                        </div>
                    </div>
                </div>
                <button onclick="deleteTodo(${todo.id})" class="text-gray-400 hover:text-red-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            `;
                list.appendChild(item);
            });
        }
        async function addTodo(event) {
            // 1. ç¬¬ä¸€æ™‚é–“é˜»æ­¢æ‰€æœ‰é è¨­è¡Œç‚º
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            const titleInput = document.getElementById('task-title');
            const categoryInput = document.getElementById('task-category');
            const priority = document.getElementById('task-priority').value;
            const dateInput = document.getElementById('task-due-date');

            const title = titleInput.value;
            const dueDate = dateInput.value;
            if (!title) return alert("è«‹è¼¸å…¥ä»»å‹™åç¨±");

            console.log("=== é–‹å§‹æ–°å¢ä»»å‹™æ¸¬è©¦ ===");

            try {
                const res = await fetch(`${API_URL}/todos/`, fetchOptions('POST', {
                    title: title,
                    category: categoryInput.value.trim() === "" ? "ä¸€èˆ¬" : categoryInput.value,
                    priority: parseInt(priority),
                    due_date: dueDate ? dueDate : null
                }));

                console.log("API å›æ‡‰ç‹€æ…‹ç¢¼:", res.status);

                if (res.ok) {
                    console.log("æ–°å¢æˆåŠŸï¼");
                    categoryInput.value = "";
                    titleInput.value = "";
                    dateInput.value = "";
                    titleInput.focus();
                    fetchTodos();
                } else {
                    const errorText = await res.text();
                    console.error("æ–°å¢å¤±æ•—ï¼Œå¾Œç«¯å›å‚³:", errorText);

                    if (res.status === 401) {
                        console.warn("æ³¨æ„ï¼šæ”¶åˆ° 401");
                    }
                }
            } catch (err) {
                console.error("ç¶²è·¯è«‹æ±‚ç™¼ç”ŸéŒ¯èª¤ï¼ˆå¯èƒ½æ˜¯ CORSï¼‰:", err);
            }
        }

        async function toggleComplete(id) {
            await fetch(`${API_URL}/todos/${id}/complete`, fetchOptions('PATCH'));
            fetchTodos();
        }

        async function deleteTodo(id) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
            await fetch(`${API_URL}/todos/${id}`, fetchOptions('DELETE'));
            fetchTodos();
        }

        // é é¢é–‹å•Ÿæ™‚å˜—è©¦æŠ“å–ï¼Œè‹¥å¤±æ•—å‰‡åœåœ¨ç™»å…¥é 
        fetchTodos().then(() => {
            // å¦‚æœè«‹æ±‚æˆåŠŸï¼ˆæœªå›å‚³ 401ï¼‰ï¼Œå‰‡è‡ªå‹•åˆ‡æ›ä»‹é¢
        });
    </script>
</body>

</html>